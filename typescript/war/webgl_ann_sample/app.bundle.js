"use strict";(()=>{var v=class i{constructor(){this.layers=[]}static{this.GAMMA=2}static{this.ALPHA=.1}static{this.WEIGHT_DECAY=4}static{this.FLAT_SPOT=.001}addLayer(t){this.layers.push(t)}getLayers(){return this.layers}recallNetwork(){for(let t of this.layers)t.recallNeurons()}meshAllNeurons(){let t=0;for(let e=1;e<this.layers.length;e++){let o=this.layers[e-1],s=this.layers[e];for(let p of s.getNeurons())for(let d of o.getNeurons())p.createLink(d,-1+.1*t++)}}trainBackpropagation(t,e,o){let s=this.layers.length-1;for(let p=0;p<o;p++)for(let d=0;d<e;d++){t.activatePatternRandom(),this.recallNetwork();for(let a of this.layers[s].getNeurons())a.calculateEvaluateOutputError();for(let a=s;a>0;a--)for(let n of this.layers[a].getNeurons())n.calculateEvaluateOutputErrorHiddenNeurons(i.FLAT_SPOT);for(let a=s;a>0;a--)for(let n of this.layers[a].getNeurons())for(let l of n.getLinks()){let u=Math.pow(10,-i.WEIGHT_DECAY)*l.weight,y=i.ALPHA*l.deltaWeigthOld;l.deltaWeigth=l.deltaWeigth-i.GAMMA*l.source.output*n.getOutputDerived()*n.getOutputError()+y-u}for(let a=s;a>0;a--)for(let n of this.layers[a].getNeurons())for(let l of n.getLinks())l.weight=l.weight+l.deltaWeigth,l.deltaWeigthOld=l.deltaWeigth,l.deltaWeigth=0;for(let a=s;a>0;a--)for(let n of this.layers[a].getNeurons())n.setOutputError(0)}}resetLinks(){for(let t of this.layers)t.resetLinks()}rms(t){let e=0,o=t.getNumberOfPattern();for(let s=0;s<o;s++){t.activatePattern(s),this.recallNetwork();for(let p of this.layers[this.layers.length-1].getNeurons())p.calculateEvaluateOutputError(),e+=Math.pow(p.getOutputError(),2)}return e/o}toString(){return`{"layers":[${this.layers.map(t=>t.toString()).join(",")}]}`}};var E=class{constructor(){this.neurons=[]}addNeuron(t){this.neurons.push(t)}getNeurons(){return Object.freeze([...this.neurons])}recallNeurons(){for(let t of this.neurons)t.recall()}resetLinks(){for(let t of this.neurons)for(let e of t.getLinks())e.weight=.1*(Math.random()-.5)}toString(){return`{"nodes":[${this.neurons.map(t=>t.toString()).join(",")}]}`}};var L=class{constructor(){this.source=null;this.weight=0;this.deltaWeigth=0;this.deltaWeigthOld=0}};var T=class{constructor(t="INNER"){this.links=[];this.output=0;this.outputExpected=0;this.outputError=0;this.input=0;this.outputDerived=1;this.type=t}createLink(t,e){if(!t)throw new Error("source is null");if(t===this)throw new Error("source equals this");let o=new L;o.source=t,o.weight=e,this.links.push(o)}getInput(){return this.input}getLinks(){return this.links}getOutput(){return this.output}getOutputDerived(){return this.outputDerived}getOutputExpected(){return this.outputExpected}isInputNeuron(){return this.type==="INPUT"}isInnerNeuron(){return this.type==="INNER"}isOutputNeuron(){return this.type==="OUTPUT"}setInput(t){if(this.type!=="INPUT")throw new Error("IllegalState: not input neuron");this.input=t}recall(){if(this.type==="INPUT")this.output=this.input,this.outputDerived=1;else{let t=0;for(let e of this.links)t+=e.source.getOutput()*e.weight;this.output=this.functionFermi(t),this.outputDerived=this.functionFermiDerive(t)}}calculateEvaluateOutputError(){if(this.type!=="OUTPUT")throw new Error("IllegalArgument: not output");this.outputError=this.output-this.outputExpected}calculateEvaluateOutputErrorHiddenNeurons(t){if(this.type==="INPUT")throw new Error("IllegalArgument: is input");for(let e of this.links){let o=this.outputDerived+t,s=e.source.getOutputError();e.source.setOutputError(o*this.outputError*e.weight+s)}}setOutputError(t){this.outputError=t}getOutputError(){return this.outputError}setOutputExpected(t){this.outputExpected=t}toString(){return`{"y":${this.output},"y_ex":${this.outputExpected}}`}functionFermi(t){return t>15?1:t<-15?0:1/(1+Math.exp(-t))}functionFermiDerive(t){let e=this.functionFermi(t);return e*(1-e)}};var k=class{constructor(){this.numberOfPattern=0;this.inputNeurons=[];this.outputNeurons=[];this.value=new Map}bind(t,e){if(!t)throw new Error("network null");if(!e)throw new Error("table null");if(e.length===0)throw new Error("empty table");let o=t.getLayers();this.inputNeurons=o[0].getNeurons(),this.outputNeurons=o[o.length-1].getNeurons();let s=this.inputNeurons.length,p=this.outputNeurons.length;if(s+p!==e[0].length)throw new Error("dimension mismatch");this.numberOfPattern=e.length,this.value=new Map;for(let d=0;d<this.numberOfPattern;d++){let a=new Map;for(let n=0;n<s;n++)a.set(this.inputNeurons[n],e[d][n]);for(let n=0;n<p;n++)a.set(this.outputNeurons[n],e[d][n+s]);this.value.set(d,a)}}getPatterns(){return this.value}activatePatternRandom(){let t=Math.floor(Math.random()*this.numberOfPattern);this.activatePattern(t)}activatePattern(t){if(t<0||t>=this.numberOfPattern)throw new Error("index out of range");let e=this.value.get(t);for(let[o,s]of e.entries())this.inputNeurons.includes(o)?o.setInput(s):o.setOutputExpected(s)}getNumberOfPattern(){return this.numberOfPattern}};var I=class i extends k{static{this.ALPHA_INCRMENT=Math.PI/180*8}static{this.PHASE_INCRMENT=Math.PI/180*5}createBindTestPattern(){let t=new v,e=20,o=15,s=10,p=new E;for(let u=0;u<e;u++)p.addNeuron(new T("INPUT"));t.addLayer(p);let d=new E;for(let u=0;u<o;u++)d.addNeuron(new T);t.addLayer(d);let a=new E;for(let u=0;u<s;u++)a.addNeuron(new T("OUTPUT"));t.addLayer(a),t.meshAllNeurons(),this.inputNeurons=t.getLayers()[0].getNeurons(),this.outputNeurons=t.getLayers()[t.getLayers().length-1].getNeurons(),this.value=new Map;let n=s;this.numberOfPattern=0;let l=0;for(let u=1;u<=n;u++)for(let y=0;y<e;y++){l+=i.PHASE_INCRMENT*u;for(let r=0;r<e;r++){let h=i.ALPHA_INCRMENT*r,m=.6+.5*Math.cos(u*h+l),c=this.value.get(this.numberOfPattern);c||(c=new Map,this.value.set(this.numberOfPattern,c)),c.set(this.inputNeurons[r],m)}for(let r=1;r<=s;r++){let h=this.value.get(this.numberOfPattern);r===u?h.set(this.outputNeurons[r-1],.9):h.set(this.outputNeurons[r-1],.1)}this.numberOfPattern++}return t.resetLinks(),t}getNumberOfPattern(){return this.numberOfPattern}};function M(i){return document.getElementById(i)}function f(i){let t=M("infoLabelContainer1");t&&(t.textContent=i),console.log(i)}function O(){if(window.__tsInitDone){console.log("initApp: already initialized \u2014 skipping");return}window.__tsInitDone=!0,f("Initializing ANN (TypeScript)...");let i=new I,t=i.createBindTestPattern();f("Created network with layers: "+t.getLayers().length);try{t.resetLinks(),t.recallNetwork(),f("Network reset on load (TS).")}catch(r){console.warn("Failed to reset network on load",r)}function e(){if(typeof window.renderData=="function")try{if(window.renderData(t.toString()),typeof window.forceRender=="function")try{window.forceRender()}catch(r){console.warn("forceRender failed",r)}f("Sent model to WebGL renderer")}catch(r){console.warn("Failed to call renderData",r)}}e();let o=document.getElementById("ts-train-button"),s=document.getElementById("ts-reset-button"),p=document.getElementById("ts-recall-button"),d=document.getElementById("ts-stop-button"),a=document.getElementById("ts-recall-interval"),n=null,l=0;function u(r){p&&(p.disabled=r),d&&(d.disabled=!r),a&&(a.disabled=r)}o&&o.addEventListener("click",()=>{console.log("Train button clicked"),n!==null&&(clearInterval(n),n=null,u(!1),f("Recall stopped due to training")),y(10,100,100).catch(h=>{console.error("Async training failed",h),o&&(o.disabled=!1)})}),s&&s.addEventListener("click",()=>{console.log("Reset button clicked"),n!==null&&(clearInterval(n),n=null,u(!1),f("Recall stopped due to reset")),t.resetLinks();try{t.recallNetwork()}catch(r){console.warn("Failed to recall network after reset",r)}f("Network links reset (TS)."),e()}),p&&p.addEventListener("click",()=>{if(console.log("Recall button clicked"),n!==null){console.log("Recall already running");return}let r=50;if(a){let c=String(a.value||"").trim(),N=c.length>0?Number(c):NaN;Number.isFinite(N)&&N>=10&&(r=Math.floor(N))}let h=Math.max(10,Math.floor(r));l=0,n=window.setInterval(()=>{try{let c=i.getNumberOfPattern?i.getNumberOfPattern():0;if(c<=0)return;i.activatePattern(l%c),t.recallNetwork(),e(),l++}catch(c){console.warn("Recall interval failed",c)}},h),u(!0);let m=document.getElementById("infoLabelContainer2");m&&(m.textContent="Recall interval: "+h+" ms"),f("Recall started (interval "+h+"ms)")}),d&&d.addEventListener("click",()=>{if(console.log("Stop button clicked"),n!==null){clearInterval(n),n=null,u(!1);let r=document.getElementById("infoLabelContainer2");r&&(r.textContent=""),f("Recall stopped")}});async function y(r,h,m=2){o&&(o.disabled=!0),f("Training (async)..."),console.log("trainAsync start",{totalIterations:r,steps:h,chunk:m});let c=r*h,N=0,A=200,P=Date.now();for(;c>0;){let w=Math.min(m,c);for(let g=0;g<w;g++)t.trainBackpropagation(i,10,10),c--,N++;e();try{let g=Date.now();if(g-P>=A){P=g;let b="n/a";try{b=t.rms(i).toFixed(6)}catch{}console.log("Training progress - remaining:",c,"completed:",N,"RMS:",b),f("Training... remaining iterations: "+c+(typeof b=="string"?"":" RMS="+b))}else f("Training... remaining iterations: "+c)}catch(g){console.warn("Progress logging failed",g)}await new Promise(g=>setTimeout(g,20))}try{let w=t.rms(i);f("Training done. RMS="+w.toFixed(6)),console.log("trainAsync done. final RMS=",w)}catch(w){console.warn("Failed to compute final RMS after training",w)}o&&(o.disabled=!1)}f("ANN (TypeScript) ready."),function(){setTimeout(()=>{try{console.log("Auto-starting training on load"),n!==null&&(clearInterval(n),n=null,u(!1),f("Recall stopped due to auto-training")),y(10,100,100).catch(m=>{console.error("Auto training failed",m)})}catch(m){console.warn("Auto-start training failed",m)}},200)}()}window.initApp=O;console.log("initApp exported on window");if(typeof document<"u"&&document.readyState==="complete")try{O()}catch(i){console.error("Error auto-initializing TS app after readyState complete",i)}typeof window<"u"&&window.addEventListener("load",()=>{try{O()}catch(i){console.error("Error initializing TS app",i)}});})();
//# sourceMappingURL=app.bundle.js.map
